!function(){"use strict";function i(i,e,n){if(e&&(i.plugin_name=e),n&&i.init){var s=i.init;i.init=function(r,o){function a(){s.call(i,r,o)}return t(r,i,e),r.readyState&&r.readyState.state>=3||!r.on?a():void r.on(n,a)}}return i}function t(i,t,e){function n(t,n){i.logger?i.logger.msg.apply(i.logger,n).module(e+""||"").level(t).log():i.log&&i.log.apply(i,n)}t.log=function(){n("log",arguments)},t.warn=function(){n("warn",arguments)},t.error=function(){n("error",arguments)}}function e(t,e,n){return i(t,e,n),t.plugin_version=s,t}function n(){this.para={distinct_id:null,is_login_id:!1,server_url:"",send_type:"beacon",login_id:null},this.log=console&&console.log||function(){},this.sd=null,this.identities={}}var s="1.25.12";n.prototype.initPara=function(i,t){if(this.sd=i,this.log=i&&i.log||this.log,this.check=i.saEvent.check,this._=i._,this.check({distinct_id:t.distinct_id})&&(this.para.distinct_id=t.distinct_id),t.is_login_id===!0&&(this.para.is_login_id=!0),this._.isString(t.server_url)&&(this.para.server_url=this._.optimizeServerUrl(t.server_url)),""===this.para.server_url){var e=this.sd.para.server_url;this._.isArray(e)?this.para.server_url=e[0]||"":this._.isString(e)&&(this.para.server_url=e)}["image","beacon","ajax"].indexOf(t.send_type)>-1&&(this.para.send_type=t.send_type)},n.prototype.init=function(i){if(!i||this.sd)return this.log("CustomDataBuilder Plugin initialization failed."),!1;this.sd=i,this.log=i&&i.log||this.log,this.check=i.saEvent.check,this._=i._;for(var t in r)this[t]=r[t]},n.prototype.createInstance=function(i){var t=new n,e=this._.isObject(i.sensors)?i.sensors:this.sd;if(t.initPara(e,i),!t.para.distinct_id){t.log("CustomDataBuilder Plugin initialization failed. parameter [distinct_id] error.",t.para.distinct_id);for(var s in r)t[s]=r[s]}return t},n.prototype.track=function(i,t){if(this.check({event:i,properties:t})){var e={type:"track",event:i,properties:this._.extend({},this.sd._.info.properties(),{$url:this._.getURL(),$title:document.title,$is_login_id:this.para.is_login_id},t)};this._.isEmptyObject(this.identities)||this._.extend(e,{identities:this.identities}),this.sendEvent(e)}},n.prototype.bind=function(i){if(!this._.isObject(i))return this.log("the identities is invalid\uff0cthe identities type must be Object."),!1;var t=0,e={},n=this;return this._.each(i,function(i,s){return!!n.check({bindKey:s,bindValue:i})&&(e[s]=i,void t++)}),t<2?void this.log("the identities is invalid\uff0cyou should have at least two identities."):(this.para.login_id&&(e.$identity_login_id=this.para.login_id),this._.extend(this.identities,e),void this.sendEvent({type:"track_id_bind",event:"$BindID",properties:this._.extend({},this.sd._.info.properties(),{$url:this._.getURL(),$title:document.title,$is_login_id:this.para.is_login_id}),identities:e}))},n.prototype.unbind=function(i,t){if(!this.check({unbindKey:i,bindValue:t}))return!1;this.identities[i]&&this.identities[i]===t&&delete this.identities[i];var e={};e[i]=t,this.sendEvent({identities:e,type:"track_id_unbind",event:"$UnbindID",properties:this._.extend({},this.sd._.info.properties(),{$url:this._.getURL(),$title:document.title,$is_login_id:this.para.is_login_id})})},n.prototype.setProfile=function(i){if(this.check({propertiesMust:i})){var t={type:"profile_set",properties:this._.extend({},{$is_login_id:this.para.is_login_id},i)};this._.isEmptyObject(this.identities)||this._.extend(t,{identities:this.identities}),this.sendEvent(t)}},n.prototype.login=function(i){if(!this.check({distinct_id:i}))return this.log("login_id id is invalid"),!1;if(i===this.para.distinct_id&&!this.para.is_login_id)return void this.log("login id is equal to distinct_id");var t={type:"track_signup",event:"$SignUp",original_id:this.para.distinct_id,properties:this._.extend({},this.sd._.info.properties(),{$url:this._.getURL(),$title:document.title,$is_login_id:this.para.is_login_id})};this._.isEmptyObject(this.identities)||this._.extend(t,{identities:this.identities}),this.para.distinct_id=i,this.para.login_id=i,this.sendEvent(t),this.para.is_login_id=!0},n.prototype.sendEvent=function(i){function t(i,t){var e=s.kit.encodeTrackData(t);return i.indexOf("?")!==-1?i+"&"+e:i+"?"+e}var e=this,n=this._,s=this.sd;if(!n.isObject(i))return void this.log("data is invalid");var r={distinct_id:this.para.distinct_id,lib:{$lib:"js",$lib_method:"code",$lib_version:String(s.lib_version)},time:1*new Date};n.extend(r,i),this.formatData(r),r._track_id=Number(String(n.getRandom()).slice(2,5)+String(n.getRandom()).slice(2,4)+String((new Date).getTime()).slice(-4)),r._flush_time=(new Date).getTime(),this.para.server_url||this.log("\u5f53\u524d server_url \u4e3a\u7a7a\u6216\u4e0d\u6b63\u786e\uff0c\u53ea\u5728\u63a7\u5236\u53f0\u6253\u5370\u65e5\u5fd7\uff0cnetwork \u4e2d\u4e0d\u4f1a\u53d1\u6570\u636e\uff0c\u8bf7\u914d\u7f6e\u6b63\u786e\u7684 server_url\uff01"),this.log(r);var o={getInstance:function(i){return"beacon"===e.para.send_type&&n.isSupportBeaconSend()?(i.data=s.kit.encodeTrackData(i.data),new n.BeaconSend(i)):"ajax"===e.para.send_type&&n.isSupportCors()?(i.data=s.kit.encodeTrackData(i.data),new n.AjaxSend(i)):(i.data.time=1*new Date,i.data=t(i.server_url,i.data),new n.ImageSend(i))},sendCall:function(i){var t=o.getInstance(i);t.start()}};if(this.para.server_url){var a={data:r,server_url:this.para.server_url};o.sendCall(a)}},n.prototype.formatData=function(i){function t(i){var t=i.properties,e=JSON.parse(JSON.stringify(i));p.isObject(t)&&p.each(t,function(i,n){if(p.isFunction(i))try{t[n]=i(e),p.isFunction(t[n])&&(_("\u60a8\u7684\u5c5e\u6027- "+n+" \u683c\u5f0f\u4e0d\u6ee1\u8db3\u8981\u6c42\uff0c\u6211\u4eec\u5df2\u7ecf\u5c06\u5176\u5220\u9664"),delete t[n])}catch(s){delete t[n],_("\u60a8\u7684\u5c5e\u6027- "+n+" \u629b\u51fa\u4e86\u5f02\u5e38\uff0c\u6211\u4eec\u5df2\u7ecf\u5c06\u5176\u5220\u9664")}})}function e(i,t){return p.isObject(i)?(p.each(i,function(e,n){if(p.isArray(e)){var s=[];p.each(e,function(i){if(p.isString(i))s.push(i);else if(p.isUndefined(i))s.push("null");else try{s.push(JSON.stringify(i))}catch(t){_("\u60a8\u7684\u6570\u636e-",n,e,"\u6570\u7ec4\u91cc\u503c\u6709\u9519\u8bef,\u5df2\u5c06\u5176\u5220\u9664")}}),i[n]=s}var r=p.indexOf(t||[],n)>-1;if(p.isObject(e)&&"$option"!==n&&!r)try{i[n]=JSON.stringify(e)}catch(o){delete i[n],_("\u60a8\u7684\u6570\u636e-",n,e,"\u6570\u636e\u503c\u6709\u9519\u8bef\uff0c\u5df2\u5c06\u5176\u5220\u9664")}else p.isString(e)||p.isNumber(e)||p.isDate(e)||p.isBoolean(e)||p.isArray(e)||p.isFunction(e)||"$option"===n||r||(_("\u60a8\u7684\u6570\u636e-",n,e,"-\u683c\u5f0f\u4e0d\u6ee1\u8db3\u8981\u6c42\uff0c\u6211\u4eec\u5df2\u7ecf\u5c06\u5176\u5220\u9664"),delete i[n])}),i):i}function n(i,t){return p.isNumber(t)&&i.length>t?(_("\u5b57\u7b26\u4e32\u957f\u5ea6\u8d85\u8fc7\u9650\u5236\uff0c\u5df2\u7ecf\u505a\u622a\u53d6--"+i),i.slice(0,t)):i}function s(i){if("item_type"in i){var t=i.item_type,e=function(t){return t||delete i.item_type,!0};l.check({item_type:t},e)}if("item_id"in i){var n=i.item_id,s=function(t,e,n){return t||"string"!==n||delete i.item_id,!0};l.check({item_id:n},s)}}function r(i,t){p.each(i,function(e,n){var s=function(t,e,s){return t||"keyLength"===s||delete i[n],!0};p.indexOf(t||[],n)===-1&&l.check({propertyKey:n},s)})}function o(i){"undefined"!=typeof i.properties.$project&&(i.project=i.properties.$project,delete i.properties.$project),"undefined"!=typeof i.properties.$token&&(i.token=i.properties.$token,delete i.properties.$token)}function a(i){var t=["$element_selector","$element_path"],e=["sensorsdata_app_visual_properties"];p.isObject(i)&&p.each(i,function(s,r){if(p.isObject(s))a(i[r]);else if(p.isString(s)){if(p.indexOf(e,r)>-1)return;i[r]=n(s,p.indexOf(t,r)>-1?1024:l.sd.para.max_string_length)}})}function d(i,t){var e=["distinct_id","user_id","id","date","datetime","event","events","first_id","original_id","device_id","properties","second_id","time","users"];p.isObject(i)&&p.each(e,function(e,n){e in i&&(p.indexOf(t||[],e)>-1||(n<3?(delete i[e],_("\u60a8\u7684\u5c5e\u6027- "+e+"\u662f\u4fdd\u7559\u5b57\u6bb5\uff0c\u6211\u4eec\u5df2\u7ecf\u5c06\u5176\u5220\u9664")):_("\u60a8\u7684\u5c5e\u6027- "+e+"\u662f\u4fdd\u7559\u5b57\u6bb5\uff0c\u8bf7\u907f\u514d\u5176\u4f5c\u4e3a\u5c5e\u6027\u540d")))})}var c=i.properties,l=this,p=this._,_=function(){l.sd.logger.msg.apply(l.sd,arguments).level("warn").log()};t(i),this._.searchObjDate(i),p.isObject(c)?(e(c),d(c),o(i),r(c),a(c)):"properties"in i&&(i.properties={}),s(i)};var r={track:function(){},register:function(){},bind:function(){},unbind:function(){},sendEvent:function(){},setProfile:function(){},login:function(){}},o=new n,a=e(o,"CustomDataBuilder","sdkAfterInitPara");return a}();